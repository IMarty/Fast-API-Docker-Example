name: Push Docker Image
# This workflow is triggered on pull requests, pushes to main, and tag creation
on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - main
        tags:
            - 'v*'  # Trigger on version tags like v1.0.0
jobs:
    build-and-test:
        # The workflow will run on the latest Ubuntu virtual machine
        runs-on: ubuntu-latest

        steps:
            # 1. Checks out your repository code so the workflow can access it
            -   name: Check out repository
                uses: actions/checkout@v4

            # 2. Sets up a specific version of Python
            -   name: Set up Python
                uses: actions/setup-python@v5
                with:
                    python-version: '3.10' # You can change this to your desired Python version

            # 3. Installs dependencies
            # We need 'pytest' to run the tests
            -   name: Install dependencies
                run: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt # <-- UPDATED: Now reads from requirements.txt

            # 4. Runs the tests
            # This command will automatically find and run the 'test_main.py' file
            -   name: Run tests with pytest
                run: |
                    pytest

    push-to-repo:
        runs-on: ubuntu-latest
        needs: build-and-test
        if: github.event_name == 'push'  # Only run on push events, not pull requests
        steps:
            -   name: Checkout Code
                uses: actions/checkout@v3

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v2

            -   name: Login to Docker Hub
                uses: docker/login-action@v2
                with:
                    username: ${{secrets.DOCKER_HUB_USERNAME}}
                    password: ${{secrets.DOCKER_HUB_TOKEN}}

            -   name: Extract version from tag or use commit hash
                id: version
                run: |
                    if [[ "${{ github.ref }}" == refs/tags/* ]]; then
                        VERSION=${GITHUB_REF#refs/tags/}
                    else
                        VERSION=latest
                    fi
                    echo "version=${VERSION}" >> $GITHUB_OUTPUT

            -   name: Build and Push with version tag
                uses: docker/build-push-action@v4
                with:
                    context: .
                    push: true
                    platforms: linux/amd64,linux/arm64
                    tags: |
                        imarty/fast-api-docker-example:${{ steps.version.outputs.version }}
                        imarty/fast-api-docker-example:latest